---
title: Qt服务器多线程实现
date: 2016-09-18 19:27:05
categories: [Qt]
tags: [Qt, 服务器]
---

  在这里总结一下我在工作中使用到的服务器与客户端编程实现的一种方法，服务器继承QTcpServer，主要的工作包括：
- 将每个连接成功的客户端放在一个线程中，各个客户端接收与发送互不干扰，并发处理
- 数据转发，使连接上的客户端可以互相通信
- 对连接上的客户端进行管理

<!-- more -->

## **结构** ##

这是整体的结构：
 ![qsc1](/img/qsc1.png) 
 
当有客户端连接服务器时，服务器接收此请求，任务管理器创建一个任务后，从线程池中的获得一个线程，将新的任务放在线程中。任务管理器负责管理和查找已连接的任务。

## **线程池**

线程池实现的方法：
![qsc2](/img/qsc2.png) 

创建一组线程，并将线程的地址放在一个空间中(数组)，对free初始化，使free中保存空闲的线程的地址。
- 当需要得到一个线程时，从free中取出一个地址，并将该地址存放在busy。busy中存放正在使用的线程
- 当一个线程不再使用时，将busy中对应的线程地址移除，并将该地址添加到free中

free中永远存放空闲的线程地址，busy中存放正在使用的线程地址。通过访问free的大小可以得到所剩线程个数，访问busy的大小得到使用的线程个数。如果free大小为0，则说明线程池中已经没有可用的线程。free和busy的大小之和为线程池中线程的个数。

在Qt中，线程池、free和busy可以使用QList来实现。

## **服务器转发** ##

为了使服务器知道应该将数据转发给哪个客户端，需要**每个客户端都有一个地址**，当客户端成功连接到服务器时，客户端必须先将自己的地址发给服务器，服务器通过任务管理器保存该客户端的地址。

客户端发送数据时，*数据帧中需要包含源地址、目的地址*，服务器收到数据后，任务管理器通过目的地址，找到对应的客户端并将数据发给对应的客户端。

## **示例** ##

改示例只是个演示示例，只将整个服务器的框架搭建完毕，客户端与服务器间的通信协议还需要根据实际情况自己制定。
在示例中，客户端使用随机数得到一个各不相同的地址，为了简便，各个客户端只能简单发送另一个客户端的地址，在对应的客户端中将收到发来的地址。

完整的示例我放在了[http://download.csdn.net/detail/u010194208/9633165](http://download.csdn.net/detail/u010194208/9633165)可以前去下载。

运行客户端，debug调试信息显示`client connected 61`，其中61为这个客户端的地址，作为客户端A;
在开一个客户端，debug调试信息显示`client connected 231`，作为客户端B；
另一个客户端，地址为37，作为客户端C。

在客户端A中输入231，发送，则客户端B将收到客户端A发来的231；
客户端输入37，发送，则客户端C将收到客户端A发来的37。

*注：该示例只是简单演示，只能输入对应客户端的地址发送，对应的客户端收数据。理解了代码后，这些都将不是问题。*